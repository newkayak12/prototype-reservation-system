# ADR: 코드 품질 자동화 도구 도입

## 배경

Spring Boot 3.4.5와 Kotlin 2.0.10 기반의 예약 시스템에서 일관된 코드 품질을 유지하고 자동화된 품질 관리 체계가 필요했습니다.

해결하고자 한 문제들:
1. **일관성 없는 코딩 스타일**: 수동 포맷팅으로 인한 불일치
2. **잠재적 코드 이슈**: 정적 분석 없이 누적되는 품질 문제
3. **테스트 커버리지 가시성 부족**: 어느 부분이 테스트되지 않았는지 불명확
4. **품질 지표 추적 어려움**: 객관적인 품질 측정 도구 부재

## 결정

**코드 품질 자동화 파이프라인 구축 - Detekt + Spotless + CodeCov + SonarQube**

### 도구 선택 이유

#### 1. **Spotless + Ktlint**: 코드 포맷팅 자동화
- Kotlin 생태계 표준 도구
- Gradle과 완벽 통합
- Pre-commit hook으로 자동 실행

#### 2. **Detekt**: Kotlin 정적 분석
- Kotlin 전용 정적 분석 도구
- 복잡도, 스타일, 버그 패턴 검출
- 커스터마이징 가능한 규칙 세트

#### 3. **CodeCov**: 테스트 커버리지 추적
- GitHub 통합 우수
- PR별 커버리지 변화 시각화
- 무료 개인 프로젝트 지원

#### 4. **SonarQube**: 종합 품질 분석
- 보안 취약점 검출
- 기술적 부채 측정
- 품질 게이트 설정

## 구현 세부사항

### Gradle 설정

```kotlin
// build.gradle.kts
plugins {
    id("com.diffplug.spotless") version "6.22.0"
    id("io.gitlab.arturbosch.detekt") version "1.23.4"
    jacoco
}

// Detekt: Zero Tolerance 정책
detekt {
    config.setFrom("$projectDir/config/detekt/detekt.yml")
    buildUponDefaultConfig = true
    allRules = false
}

// Spotless: 자동 포맷팅
spotless {
    kotlin {
        target("**/*.kt")
        ktlint("0.50.0")
        trimTrailingWhitespace()
        endWithNewline()
    }
}

// JaCoCo: 커버리지 리포트
jacocoTestReport {
    reports {
        xml.required = true  // CodeCov용
        html.required = true // 로컬 확인용
    }
}
```

### Pre-commit Hook 자동화

```kotlin
// Pre-commit에서 자동 실행되는 태스크
tasks.register("gitPreCommitHook") {
    dependsOn("spotlessApply", "detekt")
    doLast {
        exec { commandLine("git", "add", ".") }
    }
}
```

### GitHub Actions 워크플로우

```yaml
# .github/workflows/ci.yml
name: CI
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          
      - name: Run Tests & Quality Checks
        run: |
          ./gradlew test jacocoTestReport
          ./gradlew detekt
          
      - name: Upload to CodeCov
        uses: codecov/codecov-action@v3
        with:
          file: ./build/reports/jacoco/test/jacocoTestReport.xml
          
      - name: SonarQube Scan
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: ./gradlew sonarqube
```

## 품질 기준 및 현재 성과

### Detekt 규칙 (maxIssues: 0)
```yaml
complexity:
  ComplexMethod:
    threshold: 15
  LongMethod:
    threshold: 60
  TooManyFunctions:
    thresholdInClasses: 15

style:
  MaxLineLength:
    maxLineLength: 120
  FunctionNaming:
    functionPattern: '[a-z][A-Za-z0-9]*'
```

### 목표 지표
- **테스트 커버리지**: 85% 이상
- **Detekt 이슈**: 0개 (Zero Tolerance 정책)
- **SonarQube 등급**: A등급 이상
- **보안 취약점**: 0개

## 개발 워크플로우

### 일상 개발 명령어
```bash
# 코드 포맷팅 적용
./gradlew spotlessApply

# 정적 분석 실행
./gradlew detekt

# 테스트 + 커버리지
./gradlew test jacocoTestReport

# 전체 품질 검사
./gradlew check
```

### 기대 효과
- **Pre-commit hook**: 커밋 시 자동 포맷팅 + 검증
- **CI/CD**: 모든 PR에서 품질 검사 자동 실행
- **실시간 피드백**: CodeCov에서 커버리지 변화 즉시 확인

## 기대 효과

### 정량적 개선 목표
1. **품질 이슈 제거**: 정적 분석으로 잠재적 버그 사전 방지
2. **커버리지 향상**: 테스트되지 않은 코드 영역 명확화
3. **개발 효율성**: 수동 포맷팅 시간 제거
4. **일관성 확보**: 프로젝트 전체 코딩 스타일 통일

### 품질 모니터링 대시보드
- **CodeCov**: 커버리지 트렌드 및 파일별 상세 정보
- **SonarQube**: 기술적 부채, 보안 취약점, 코드 스멜 추적
- **GitHub**: PR별 품질 변화 자동 리포트

## 제약사항 및 고려사항

### 제약사항
1. **빌드 시간 증가**: 정적 분석으로 약 10-15% 증가
2. **초기 설정 복잡성**: 각 도구별 설정 파일 관리 필요
3. **False Positive**: 간헐적인 Detekt 오탐 이슈

### 완화 방안
```kotlin
// Detekt 특정 규칙 예외 처리
detekt {
    baseline = file("$projectDir/config/detekt/baseline.xml")
}

// Spotless 제외 파일 설정
spotless {
    kotlin {
        targetExclude("**/generated/**")
    }
}
```

## 향후 개선 계획

### 단기 (3개월)
- [ ] 커버리지 90% 달성
- [ ] Custom Detekt 규칙 추가
- [ ] 성능 영향 모니터링

### 장기 (6개월)
- [ ] 품질 메트릭 확장 (복잡도, 응집도)
- [ ] 자동 보안 스캔 추가
- [ ] 품질 트렌드 분석 자동화

---

# 중간 결과 

## 도입 성과

### 달성된 지표
- ✅ **테스트 커버리지**: 88% (목표 85% 초과 달성)
- ✅ **Detekt 이슈**: 0개 (Zero Tolerance 정책 완전 달성)
- ✅ **SonarQube 등급**: A등급 (목표 달성)
- ✅ **보안 취약점**: 0개 (목표 달성)

### 모듈별 품질 현황
```
├── core-module      : 95% 커버리지
├── application-module: 90% 커버리지  
├── adapter-module   : 85% 커버리지
└── shared-module    : 92% 커버리지
```

### 실제 도입 효과
1. **개발 효율성 향상**: Pre-commit hook으로 수동 포맷팅 시간 완전 제거
2. **품질 안정성**: 정적 분석으로 런타임 오류 사전 차단
3. **지속적 모니터링**: CodeCov/SonarQube 대시보드로 실시간 품질 추적
4. **자동화 성공**: GitHub Actions로 품질 검사 완전 자동화

### 예상치 못한 장점
- **코드 리뷰 품질 향상**: 스타일 이슈 제거로 비즈니스 로직에 집중
- **리팩터링 안전성**: 높은 커버리지로 안전한 코드 변경 가능
- **학습 효과**: Detekt 규칙을 통한 Kotlin 베스트 프랙티스 습득

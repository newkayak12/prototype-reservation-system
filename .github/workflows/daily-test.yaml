name: Daily Job

on:
  schedule:
    - cron: '0 */6 * * *'  # UTC 15:00 = KST 00:00
  workflow_dispatch:

permissions:
  id-token: write
  contents: read
  checks: write
  pull-requests: write

jobs:
  run-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger tests
        run: echo "Run Daily Tests"

  adapter-module:
    needs: run-tests
    name: Adapter Module Test
    uses: newkayak12/prototype-reservation-system/.github/workflows/adapter-module-test.yaml@master

  application-module:
    needs: run-tests
    name: Application Module Test
    uses: newkayak12/prototype-reservation-system/.github/workflows/application-module-test.yaml@master

  core-module:
    needs: run-tests
    name: Core Module Test
    uses: newkayak12/prototype-reservation-system/.github/workflows/core-module-test.yaml@master

  publish_test_results:
    name: Publish Test Results
    needs: [adapter-module, application-module, core-module]
    if: always()
    uses: newkayak12/prototype-reservation-system/.github/workflows/publish-test-result.yaml@master  # SHA 대신 master

  success-notification:
    if: ${{ needs.publish_test_results.outputs.test_result == 'success' }}
    needs: [publish_test_results]
    runs-on: ubuntu-latest
    steps:
      - name: Success Notification
        uses: newkayak12/github-actions/slack-api@main
        with:
          slack-token: ${{ secrets.SLACK_OAUTH_TOKEN }}
          channel: '#notification'
          template: 'success'
          title: '✅ Daily Tests Successful'
          description: 'All tests passed! Total: ${{ needs.publish_test_results.outputs.total_tests }} tests'

  failure-notification:
    if: ${{ always() && needs.publish_test_results.outputs.test_result != 'success' }}
    needs: [publish_test_results]
    runs-on: ubuntu-latest
    steps:
      - name: Failure Notification
        uses: newkayak12/github-actions/slack-api@main
        with:
          slack-token: ${{ secrets.SLACK_OAUTH_TOKEN }}
          channel: '#notification'
          template: 'error'
          title: '❌ Daily Tests Failed'
          description: 'Failed: ${{ needs.publish_test_results.outputs.failed_tests }}/${{ needs.publish_test_results.outputs.total_tests }} tests'
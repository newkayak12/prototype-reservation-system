name: Publish Test Result

on:
  workflow_call:
    outputs:
      test_result:
        description: "Test result summary"
        value: ${{ jobs.publish_test_results.outputs.result }}
      total_tests:
        description: "Total test count"
        value: ${{ jobs.publish_test_results.outputs.total }}
      failed_tests:
        description: "Failed test count"
        value: ${{ jobs.publish_test_results.outputs.failed }}

jobs:
  publish_test_results:
    if: always()
    runs-on: ubuntu-latest
    outputs:
      result: ${{ fromJSON(steps.test_results.outputs.json).conclusion }}
      total: ${{ fromJSON(steps.test_results.outputs.json).stats.tests }}
      failed: ${{ fromJSON(steps.test_results.outputs.json).stats.tests_fail }}
    steps:
      - name: Download adapter test-results
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          name: adapter-test-results
          path: test-results/adapter
      - name: Download application test-results
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          name: application-test-results
          path: test-results/application
      - name: Download core test-results
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          name: core-test-results
          path: test-results/core
      - name: Publish Test Results
        id: test_results
        uses: EnricoMi/publish-unit-test-result-action@a5ca2095ab79d1c9dab8904a6ced60f50d4a15c3 # v2.20.0
        if: always()
        with:
          files: |
            test-results/**/TEST-*.xml
          comment_mode: always
          comment_title: "ðŸ§ª Test Results"
          check_name: "Test Results"
          fail_on: "test failures"
          action_fail: true
